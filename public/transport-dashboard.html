<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Ape's Console">
    <meta name="author" content="">
    <link rel="icon" href="/resources/bootstrap/favicon.ico">

    <title>SmartCom</title>

    <!-- Bootstrap core CSS -->
    <link href="/resources/bootstrap/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	
    <!-- MetisMenu CSS -->
    <link href="/resources/bootstrap/vendor/metisMenu/metisMenu.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="/resources/bootstrap/dist/css/sb-admin-2.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/resources/bootstrap/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

	<link href="/resources/reports/css/dc.css" rel="stylesheet" type="text/css">
    

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
	<style>
		.fonty {
			color: #687888;
		}
		.icon {
			width: 40px;
			height: 40px;
			color: green;
		}		
	</style>

  <body>
	<style>			
	
	</style>
    <div id="wrapper" ng-app="transportApp" ng-controller="transportCtrl">
        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0;  background-color: #687888;">
			<div class="navbar-header">
                <a class="navbar-brand" style='color: white; font-size: 12px;' href="transport">
					<strong style='font-size: 17px; font-style:italic;'>smart<strong style='font-size: 20px; font-style:italic;'>Com</strong> | </strong> <strong> Welcome</strong> : {{name}}
				</a>
            </div>
			<leftmenu></leftmenu>
		</nav>
		<div id="page-wrapper">
			<div class="row">
				<div class="col-lg-12">
					<h1 class="page-header fonty">Dashboard</h1>
					<a href='javascript:dc.filterAll(); dc.renderAll();'>Reset All</a>
				</div>
			</div>	
			<div class="row">
				<div class="panel-body">
                    <div id="month-chart"></div>
                    <div id="car-max-chart"></div>
                    <div id="car-min-chart"></div>
                </div>			
			</div>
		</div>
	</div>
	<!-- Angular -->
	<script src="/resources/angular/angular.min.js"></script>
    <!-- jQuery -->
    <script src="/resources/bootstrap/vendor/jquery/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/resources/bootstrap/vendor/bootstrap/js/bootstrap.min.js"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="/resources/bootstrap/vendor/metisMenu/metisMenu.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="/resources/bootstrap/dist/js/sb-admin-2.js"></script>


  <script src="https://dc-js.github.io/dc.js/js/d3.js"></script>
  <script src="https://dc-js.github.io/dc.js/js/crossfilter.js"></script>
  <script src="https://dc-js.github.io/dc.js/js/dc.js"></script>
	
  </body>
</html>
<script>
	var transport = angular.module('transportApp', []);	
	var typeMaxChart = dc.pieChart('#car-max-chart');
	var typeMinChart = dc.pieChart('#car-min-chart');
	var histChart = dc.barChart('#month-chart');
	var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
	var ndx = crossfilter([]);
	var drawChart = function(){
		var all = ndx.groupAll();

		var monthDim = ndx.dimension(function(d){
			return d.month;
		});

		var maxTypeDim = ndx.dimension(function(d){
			return d.maxType;
		});

		var minTypeDim = ndx.dimension(function(d){
			return d.minType;
		});

		var groupByMonth = monthDim.group().reduceSum(function(d){
			return +d.totalPerMonth;
		});    

		var maxPerMonth = maxTypeDim.group().reduceSum(function(d){
			return +d.maxCount;
		}); 

		var minPerMonth = minTypeDim.group().reduceSum(function(d){
			return +d.minCount;
		}); 

        histChart
	        .width(500)
	        .height(200)
	        .dimension(monthDim)
	        .group(groupByMonth)
	        .x(d3.scale.ordinal())
	        .xUnits(dc.units.ordinal)
	        .elasticX(true)
	        .elasticY(true);
        histChart.xAxis().tickFormat(function(d){
        	return months[d - 1];
        });
        histChart.yAxis().tickFormat(function(d){
        	return d/1000 + 'K';
        });

        typeMaxChart
	        .width(500)
	        .height(200)
	        .dimension(maxPerMonth)
	        .group(maxPerMonth)
	        .innerRadius(20);

	    typeMinChart
	        .width(500)
	        .height(200)
	        .dimension(minTypeDim)
	        .group(minPerMonth)
	        .innerRadius(20);

		dc.renderAll();
	}

	transport.directive('leftmenu', function($compile) {
		var directive = {};
		directive.restrict = 'E';
		directive.templateUrl = "/resources/templates/transport-left-menu.html";		
		directive.controller = function($scope, $rootScope, $http) {
			$scope.dasboardtab = 'active';			
		};		
		return directive;
	});	
	transport.controller('transportCtrl', function($scope, $http) {
		$http.get("/getuser")
		.then(function(response) {
			$scope.name = response.data.name;
		});	

		$http.get("/getmonthlydata")
		.then(function(response) {
			ndx.add(response.data.sort());
			drawChart();
			dc.renderAll();
		});	
		
	});
</script>
